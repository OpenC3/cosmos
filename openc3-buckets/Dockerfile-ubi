ARG OPENC3_UBI_REGISTRY=registry1.dso.mil
ARG OPENC3_UBI_IMAGE=ironbank/redhat/ubi/ubi9-minimal
ARG OPENC3_UBI_TAG=9.6
ARG OPENC3_VERSITYGW_VERSION=v1.2.0

FROM ${OPENC3_UBI_REGISTRY}/${OPENC3_UBI_IMAGE}:${OPENC3_UBI_TAG}

ARG OPENC3_VERSITYGW_VERSION
ARG TARGETARCH

# Install tar and gzip for extracting versitygw
RUN microdnf install -y tar gzip && microdnf clean all

# Copy and extract versitygw binary from local tar.gz files
COPY versitygw_${OPENC3_VERSITYGW_VERSION}*.tar.gz /tmp/
RUN ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "x86_64") && \
    tar xzf /tmp/versitygw_${OPENC3_VERSITYGW_VERSION}_Linux_${ARCH}.tar.gz -C /tmp versitygw_${OPENC3_VERSITYGW_VERSION}_Linux_${ARCH}/versitygw && \
    mv /tmp/versitygw_${OPENC3_VERSITYGW_VERSION}_Linux_${ARCH}/versitygw /usr/local/bin/ && \
    chmod +x /usr/local/bin/versitygw && \
    rm -rf /tmp/versitygw_*

COPY cacert.pem /devel/cacert.pem
ENV SSL_CERT_FILE=/devel/cacert.pem
ENV CURL_CA_BUNDLE=/devel/cacert.pem
ENV REQUESTS_CA_BUNDLE=/devel/cacert.pem
ENV NODE_EXTRA_CA_CERTS=/devel/cacert.pem

COPY --chown=1001:1001 --chmod=755 docker-entrypoint.sh /usr/bin/

RUN microdnf update -y && \
    microdnf clean all && \
    rm -rf /var/cache/yum && \
    chmod +x /usr/bin/docker-entrypoint.sh && \
    mkdir -p /data && \
    chown 1001:1001 /data && \
    chmod -R 777 /data

USER 1001
EXPOSE 9000
VOLUME /data
ENTRYPOINT ["/usr/bin/docker-entrypoint.sh"]
CMD ["versitygw"]
