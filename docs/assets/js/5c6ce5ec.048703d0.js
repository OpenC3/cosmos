"use strict";(self.webpackChunkdocs_openc3_com=self.webpackChunkdocs_openc3_com||[]).push([["9621"],{2287:function(e,n,t){t.r(n),t.d(n,{metadata:()=>i,default:()=>h,frontMatter:()=>d,contentTitle:()=>c,toc:()=>a,assets:()=>l});var i=JSON.parse('{"id":"development/streaming-api","title":"Streaming API","description":"Using the websocket streaming API to retrieve data","source":"@site/docs/development/streaming-api.md","sourceDirName":"development","slug":"/development/streaming-api","permalink":"/docs/development/streaming-api","draft":false,"unlisted":false,"editUrl":"https://github.com/OpenC3/cosmos/tree/main/docs.openc3.com/docs/development/streaming-api.md","tags":[],"version":"current","frontMatter":{"title":"Streaming API","description":"Using the websocket streaming API to retrieve data","sidebar_custom_props":{"myEmoji":"\u{1F4DD}"}},"sidebar":"defaultSidebar","previous":{"title":"Roadmap","permalink":"/docs/development/roadmap"},"next":{"title":"Testing COSMOS","permalink":"/docs/development/testing"}}'),s=t(2615),r=t(9496);let d={title:"Streaming API",description:"Using the websocket streaming API to retrieve data",sidebar_custom_props:{myEmoji:"\u{1F4DD}"}},c,l={},a=[{value:"Ruby Example",id:"ruby-example",level:2},{value:"StreamingApi Architecture",id:"streamingapi-architecture",level:2},{value:"Architecture Diagram",id:"architecture-diagram",level:2},{value:"File Reference",id:"file-reference",level:2},{value:"Primary Files (cmd-tlm-api/app/models/)",id:"primary-files-cmd-tlm-apiappmodels",level:3},{value:"Channel Files (cmd-tlm-api/app/channels/)",id:"channel-files-cmd-tlm-apiappchannels",level:3},{value:"Core Library Files (openc3/lib/openc3/)",id:"core-library-files-openc3libopenc3",level:3},{value:"Test File",id:"test-file",level:3},{value:"Data Structures",id:"data-structures",level:2},{value:"StreamingObject",id:"streamingobject",level:3},{value:"StreamingObjectCollection",id:"streamingobjectcollection",level:3},{value:"Client Request Format (add)",id:"client-request-format-add",level:3},{value:"Result Transmission Format",id:"result-transmission-format",level:3},{value:"Thread Model",id:"thread-model",level:2},{value:"Thread Hierarchy",id:"thread-hierarchy",level:3},{value:"Thread 1: RealtimeStreamingThread",id:"thread-1-realtimestreamingthread",level:3},{value:"Thread 2: LoggedStreamingThread",id:"thread-2-loggedstreamingthread",level:3},{value:"Thread 3: BucketFileCache Thread",id:"thread-3-bucketfilecache-thread",level:3},{value:"Thread Synchronization",id:"thread-synchronization",level:3},{value:"Thread Shutdown (<code>kill</code>)",id:"thread-shutdown-kill",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Realtime Streaming (no start_time)",id:"realtime-streaming-no-start_time",level:3},{value:"Historical \u2192 Realtime Streaming (with start_time, no end_time)",id:"historical--realtime-streaming-with-start_time-no-end_time",level:3},{value:"Historical Only (with start_time and past end_time)",id:"historical-only-with-start_time-and-past-end_time",level:3},{value:"LATEST Item Resolution",id:"latest-item-resolution",level:3},{value:"Handoff: Logged \u2192 Realtime",id:"handoff-logged--realtime",level:3},{value:"Data Sources",id:"data-sources",level:2},{value:"1. Valkey (Redis) Streams",id:"1-valkey-redis-streams",level:3},{value:"2. QuestDB (Time-Series Database)",id:"2-questdb-time-series-database",level:3},{value:"3. S3 Bucket Log Files",id:"3-s3-bucket-log-files",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2}];function o(e){let n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.admonition,{title:"This documentation is for COSMOS Developers",type:"note",children:(0,s.jsx)(n.p,{children:"This information is just generally used behind the scenes in COSMOS tools"})}),"\n",(0,s.jsx)(n.p,{children:"The COSMOS Streaming Api is the primary interface to receive a stream of the telemetry packets and/or command packets that have passed through the COSMOS system, both logged and continuously in realtime. Either raw binary packets or decommutated JSON packets can be requested."}),"\n",(0,s.jsx)(n.p,{children:"This API is implemented over Websockets using the Rails ActionCable framework. Actioncable client libraries are known to exist for at least Javascript, Ruby, and Python. Other languages may exist or could be created. Websockets allow for easy interaction with the new COSMOS Javascript based frontend."}),"\n",(0,s.jsx)(n.p,{children:"The following interactions are all shown in Javascript, but would be very similar in any language.\nConnecting to this API begins by initiating an ActionCable connection."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"cable = ActionCable.createConsumer('/openc3-api/cable')\n"})}),"\n",(0,s.jsx)(n.p,{children:"This call opens the HTTP connection to the given URL and upgrades it to a websocket connection. This connection can then be shared with multiple \u201Csubscriptions\u201D."}),"\n",(0,s.jsx)(n.p,{children:"A subscription describes a set of data that you want the API to stream to you. Creating a subscription looks like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'subscription = cable.subscriptions.create(\n  {\n    channel: "StreamingChannel",\n    scope: "DEFAULT",\n    token: token,\n  },\n  {\n    received: (data) => {\n      // Handle received data\n    },\n    connected: () => {\n      // First chance to add what you want to stream here\n    },\n    disconnected: () => {\n      // Handle the subscription being disconnected\n    },\n    rejected: () => {\n      // Handle the subscription being rejected\n    },\n  },\n);\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Subscribing to the StreamingApi requires passing a channel name set to \u201CStreamingChannel\u201D, a scope which is typically \u201CDEFAULT\u201D, and an access token (a password in COSMOS Core). In Javascript you also pass a set of callback functions that run at various lifecycle points in the subscription. The most important of these are ",(0,s.jsx)(n.code,{children:"connected"})," and ",(0,s.jsx)(n.code,{children:"received"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"connected"})," runs when the subscription is accepted by the StreamApi. This callback is the first opportunity to request specific data that you would like streamed. Data can also be added or removed at any time while the subscription is open."]}),"\n",(0,s.jsx)(n.p,{children:"Data can be added to the stream by requesting individual items from a packet or by requesting the entire packet."}),"\n",(0,s.jsx)(n.p,{children:"Adding items to stream is done as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'var items = [\n  ["DECOM__TLM__INST__ADCS__Q1__RAW", "0"],\n  ["DECOM__CMD__INST__COLLECT__DURATION__FORMATTED", "1"],\n];\nOpenC3Auth.updateToken(OpenC3Auth.defaultMinValidity).then(() => {\n  this.subscription.perform("add", {\n    scope: window.openc3Scope,\n    token: localStorage.openc3Token,\n    items: items,\n    start_time: this.startDateTime,\n    end_time: this.endDateTime,\n  });\n});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The values in the item name are separated by double underscores, e.g. ",(0,s.jsx)(n.code,{children:"<MODE>__<CMD or TLM>__<TARGET NAME>__<PACKET NAME>__<ITEM NAME>__<VALUE TYPE>__<REDUCED TYPE>"}),". Mode is either RAW, DECOM, REDUCED_MINUTE, REDUCED_HOUR, or REDUCED_DAY. The next parameter is CMD or TLM followed by the target, packet and item names. The Value Type is one of RAW, CONVERTED or FORMATTED. The last parameter is optional if you want to use the reduced data types. Reduced Type is one of SAMPLE, MIN, MAX, AVG, or STDDEV."]}),"\n",(0,s.jsx)(n.p,{children:"Adding packets to stream is done as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'var packets = [\n  ["RAW__TLM__INST__ADCS", "0"],\n  ["DECOM__TLM__INST__HEALTH_STATUS__FORMATTED", "1"],\n];\nOpenC3Auth.updateToken(OpenC3Auth.defaultMinValidity).then(() => {\n  this.subscription.perform("add", {\n    scope: window.openc3Scope,\n    token: localStorage.openc3Token,\n    packets: packets,\n    start_time: this.startDateTime,\n    end_time: this.endDateTime,\n  });\n});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The values in the packet name are separated by double underscores, e.g. ",(0,s.jsx)(n.code,{children:"<MODE>__<CMD or TLM>__<TARGET NAME>__<PACKET NAME>__<VALUE TYPE>"}),". Mode is either RAW or DECOM. The next parameter is CMD or TLM followed by the target and packet names. The Value Type is one of RAW, CONVERTED or FORMATTED."]}),"\n",(0,s.jsx)(n.p,{children:"For Raw mode, VALUE TYPE should be set to RAW or omitted (e.g. TLM__INST__ADCS__RAW or TLM__INST__ADCS).\nstart_time and end_time are standard COSMOS 64-bit integer timestamps in nanoseconds since the Unix Epoch (midnight January 1st, 1970). If start_time is null, that indicates to start streaming from the current time in realtime, indefinitely until items are removed, or the subscription is unsubscribed. end_time is ignored if start_time is null. If start_time is given and end_time is null, that indicates to playback from the given starttime and then continue indefinitely in realtime. If both start_time and end_time are given, then that indicates a temporary playback of historical data."}),"\n",(0,s.jsx)(n.p,{children:"Data returned by the streaming API is handled by the received callback in Javascript. Data is returned as a JSON Array, with a JSON object in the array for each packet returned. Results are batched, and the current implementation will return up to 100 packets in each batch (the array will have 100 entries). 100 packets per batch is not guaranteed, and batches may take on varying sizes based on the size of the data returned, or other factors. An empty array indicates that all data has been sent for a purely historical query and can be used as an end of data indicator."}),"\n",(0,s.jsx)(n.p,{children:"For decommutated items, each packet is represented as a JSON object with a 'time' field holding the COSMOS nanosecond timestamp of the packet, and then each of the requested item keys with their corresponding value from the packet."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "time": 1234657585858,\n    "TLM__INST__ADCS__Q1__RAW": 50.0,\n    "TLM__INST__ADCS__Q2__RAW": 100.0\n  },\n  {\n    "time": 1234657585859,\n    "TLM__INST__ADCS__Q1__RAW": 60.0,\n    "TLM__INST__ADCS__Q2__RAW": 110.0\n  }\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:"For raw packets, each packet is represented as a JSON object with a time field holding the COSMOS nanosecond timestamp of the packet, a packet field holding the topic the packet was read from in the form of SCOPE__TELEMETRY__TARGETNAME__PACKETNAME, and a buffer field holding a BASE64 encoded copy of the packet data."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "time": 1234657585858,\n    "packet": "DEFAULT__TELEMETRY__INST__ADCS",\n    "buffer": "SkdfjGodkdfjdfoekfsg"\n  },\n  {\n    "time": 1234657585859,\n    "packet": "DEFAULT__TELEMETRY__INST__ADCS",\n    "buffer": "3i5n49dmnfg9fl32k3"\n  }\n]\n'})}),"\n",(0,s.jsx)(n.h2,{id:"ruby-example",children:"Ruby Example"}),"\n",(0,s.jsx)(n.p,{children:"Below is a simple Ruby example for using the streaming API to retrieve telemetry data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ruby",children:"require 'openc3'\nrequire 'openc3/script/web_socket_api'\n\n$openc3_scope = 'DEFAULT'\nENV['OPENC3_API_HOSTNAME'] = '127.0.0.1'\nENV['OPENC3_API_PORT'] = '2900'\nENV['OPENC3_API_PASSWORD'] = 'password'\n# The following are needed for Enterprise (change user/pass as necessary)\n#ENV['OPENC3_API_USER'] = 'operator'\n#ENV['OPENC3_API_PASSWORD'] = 'operator'\n#ENV['OPENC3_KEYCLOAK_REALM'] = 'openc3'\n#ENV['OPENC3_KEYCLOAK_URL'] = 'http://127.0.0.1:2900/auth'\n\n# Open a file to write CSV data\ncsv = File.open('telemetry_data.csv', 'w')\n\n# Connect to the streaming API\nOpenC3::StreamingWebSocketApi.new() do |api|\n  # Add items to stream - request data from yesterday to 1 minute ago\n  api.add(items: [\n    'DECOM__TLM__INST__HEALTH_STATUS__TEMP1__CONVERTED',\n    'DECOM__TLM__INST__HEALTH_STATUS__TEMP2__CONVERTED'\n  ],\n  start_time: (Time.now - 86400).to_nsec_from_epoch,  # 24 hours ago\n  end_time: (Time.now - 60).to_nsec_from_epoch)       # 1 minute ago\n\n  # Write CSV header\n  csv.puts \"Time,TEMP1,TEMP2\"\n\n  # Read all data from the stream\n  data = api.read\n\n  # Process each data point\n  data.each do |item|\n    csv.puts \"#{item['__time']/1_000_000_000.0},#{item['DECOM__TLM__INST__HEALTH_STATUS__TEMP1__CONVERTED']},#{item['DECOM__TLM__INST__HEALTH_STATUS__TEMP2__CONVERTED']}\"\n  end\nend\ncsv.close()\n"})}),"\n",(0,s.jsx)(n.h2,{id:"streamingapi-architecture",children:"StreamingApi Architecture"}),"\n",(0,s.jsxs)(n.p,{children:["The Streaming API is a server-side subsystem within the ",(0,s.jsx)(n.code,{children:"openc3-cosmos-cmd-tlm-api"})," Rails microservice that provides real-time and historical telemetry/command data streaming to web clients over WebSockets (ActionCable). It supports streaming individual telemetry items, whole packets, and aggregated (reduced) data from multiple data sources: Valkey (Redis) streams, QuestDB (time-series database), and S3-compatible bucket log files."]}),"\n",(0,s.jsx)(n.h2,{id:"architecture-diagram",children:"Architecture Diagram"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Web Client (Browser)                        \u2502\n\u2502                    Vue.js Frontend (ActionCable JS)                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                \u2502 WebSocket (AnyCable)\n                                \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     StreamingChannel (ActionCable)                  \u2502\n\u2502  app/channels/streaming_channel.rb                                 \u2502\n\u2502  - subscribed() \u2192 creates StreamingApi instance                    \u2502\n\u2502  - add(data) \u2192 delegates to StreamingApi#add                       \u2502\n\u2502  - remove(data) \u2192 delegates to StreamingApi#remove                 \u2502\n\u2502  - unsubscribed() \u2192 calls StreamingApi#kill                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                \u2502\n                                \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        StreamingApi                                 \u2502\n\u2502  app/models/streaming_api.rb                                       \u2502\n\u2502  - Orchestrates streaming threads                                  \u2502\n\u2502  - Manages 0..1 RealtimeStreamingThread                            \u2502\n\u2502  - Manages 0..N LoggedStreamingThread instances                    \u2502\n\u2502  - Broadcasts results via ActionCable                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n            \u2502                   \u2502\n            \u25BC                   \u25BC\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 RealtimeStreaming-   \u2502 \u2502 LoggedStreamingThread                      \u2502\n\u2502 Thread               \u2502 \u2502 app/models/logged_streaming_thread.rb      \u2502\n\u2502 app/models/realtime_ \u2502 \u2502 - Reads from QuestDB (TSDB mode)           \u2502\n\u2502 streaming_thread.rb  \u2502 \u2502 - Reads from Valkey (STREAM mode)          \u2502\n\u2502 - Reads from Valkey  \u2502 \u2502 - Reads from S3 files (RAW packets)        \u2502\n\u2502   streams in real-   \u2502 \u2502 - Hands off to realtime when caught up     \u2502\n\u2502   time               \u2502 \u2502                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502                 \u2502              \u2502\n           \u25BC                 \u25BC              \u25BC\n    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502  Valkey   \u2502   \u2502   QuestDB    \u2502  \u2502 S3 Bucket Log Files  \u2502\n    \u2502  Streams  \u2502   \u2502   (TSDB)     \u2502  \u2502 (via BucketFileCache \u2502\n    \u2502           \u2502   \u2502              \u2502  \u2502  + PacketLogReader)  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"file-reference",children:"File Reference"}),"\n",(0,s.jsx)(n.h3,{id:"primary-files-cmd-tlm-apiappmodels",children:"Primary Files (cmd-tlm-api/app/models/)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Class"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_api.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingApi"})}),(0,s.jsx)(n.td,{children:"Top-level orchestrator. Manages thread lifecycle, item collections, and result transmission."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_thread.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingThread"})}),(0,s.jsx)(n.td,{children:"Abstract base class for streaming threads. Contains shared logic for Redis reading, message handling, batch transmission, and object lifecycle."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"realtime_streaming_thread.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"RealtimeStreamingThread"})}),(0,s.jsxs)(n.td,{children:["Subclass of ",(0,s.jsx)(n.code,{children:"StreamingThread"}),". Continuously reads from Valkey streams for live data."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"logged_streaming_thread.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})}),(0,s.jsxs)(n.td,{children:["Subclass of ",(0,s.jsx)(n.code,{children:"StreamingThread"}),". Reads historical data from QuestDB and/or Valkey, then hands off to realtime."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_object.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingObject"})}),(0,s.jsx)(n.td,{children:"Data class representing a single streaming subscription item (one item or one packet)."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_object_collection.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingObjectCollection"})}),(0,s.jsxs)(n.td,{children:["Thread-safe collection of ",(0,s.jsx)(n.code,{children:"StreamingObject"})," instances, indexed by topic, id, and type."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_object_file_reader.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingObjectFileReader"})}),(0,s.jsx)(n.td,{children:"Reads raw packet data from S3 bucket log files in time order across multiple files."})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"channel-files-cmd-tlm-apiappchannels",children:"Channel Files (cmd-tlm-api/app/channels/)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Class"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"streaming_channel.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingChannel"})}),(0,s.jsx)(n.td,{children:"ActionCable channel. Entry point for WebSocket streaming requests."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"application_cable/connection.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ApplicationCable::Connection"})}),(0,s.jsx)(n.td,{children:"WebSocket connection authentication. Authorizes via token and assigns UUID/scope."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"application_cable/channel.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ApplicationCable::Channel"})}),(0,s.jsx)(n.td,{children:"Base ActionCable channel class."})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"core-library-files-openc3libopenc3",children:"Core Library Files (openc3/lib/openc3/)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Class"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"topics/topic.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::Topic"})}),(0,s.jsxs)(n.td,{children:["Delegates to ",(0,s.jsx)(n.code,{children:"EphemeralStore"})," (Valkey). Provides ",(0,s.jsx)(n.code,{children:"read_topics"}),", ",(0,s.jsx)(n.code,{children:"get_oldest_message"}),", ",(0,s.jsx)(n.code,{children:"get_last_offset"}),"."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"utilities/questdb_client.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::QuestDBClient"})}),(0,s.jsx)(n.td,{children:"QuestDB utility: value encoding/decoding, table/column name sanitization, timestamp formatting, sentinel value handling."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"utilities/bucket_file_cache.rb"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"BucketFileCache"})," / ",(0,s.jsx)(n.code,{children:"BucketFile"})]}),(0,s.jsx)(n.td,{children:"Singleton cache for S3 bucket files. Downloads, caches locally, manages disk usage and file lifecycle."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"logs/buffered_packet_log_reader.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::BufferedPacketLogReader"})}),(0,s.jsx)(n.td,{children:"Reads packet log files with buffering to enable time-ordered reading across multiple files."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"packets/json_packet.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::JsonPacket"})}),(0,s.jsxs)(n.td,{children:["Represents a decommutated packet as JSON. Provides ",(0,s.jsx)(n.code,{children:"read()"})," and ",(0,s.jsx)(n.code,{children:"read_all()"})," for extracting item values."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"utilities/authorization.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::Authorization"})}),(0,s.jsxs)(n.td,{children:["Authorization mixin. Provides ",(0,s.jsx)(n.code,{children:"authorize()"})," method for permission checks."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"models/target_model.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::TargetModel"})}),(0,s.jsxs)(n.td,{children:["Target configuration model. Provides ",(0,s.jsx)(n.code,{children:"get_item_to_packet_map()"}),", ",(0,s.jsx)(n.code,{children:"packet()"}),", ",(0,s.jsx)(n.code,{children:"packet_item()"}),"."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"utilities/bucket_utilities.rb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenC3::BucketUtilities"})}),(0,s.jsxs)(n.td,{children:["S3 bucket utilities. Provides ",(0,s.jsx)(n.code,{children:"files_between_time()"})," for finding log files in time ranges."]})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"test-file",children:"Test File"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"spec/models/streaming_api_spec.rb"})}),(0,s.jsx)(n.td,{children:"RSpec tests covering realtime, logged, file-based, and reduced streaming scenarios."})]})})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-structures",children:"Data Structures"}),"\n",(0,s.jsx)(n.h3,{id:"streamingobject",children:"StreamingObject"}),"\n",(0,s.jsx)(n.p,{children:"Represents a single subscription to either a telemetry/command item or a whole packet."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ruby",children:'class StreamingObject\n  attr_reader :key            # Full key string, e.g. "DECOM__TLM__INST__ADCS__Q1__CONVERTED"\n  attr_reader :stream_mode    # Symbol: :RAW, :DECOM, :REDUCED_MINUTE, :REDUCED_HOUR, :REDUCED_DAY\n  attr_reader :cmd_or_tlm     # Symbol: :CMD or :TLM\n  attr_reader :target_name    # String: target name, e.g. "INST"\n  attr_reader :packet_name    # String: packet name, e.g. "ADCS"\n  attr_reader :item_name      # String or nil: item name (nil for whole packets)\n  attr_reader :value_type     # Symbol: :RAW, :CONVERTED, :FORMATTED, :WITH_UNITS, :PURE\n  attr_reader :reduced_type   # Symbol or nil: :MIN, :MAX, :AVG, :STDDEV (reduced modes only)\n  attr_accessor :start_time   # Integer or nil: nanoseconds from epoch\n  attr_accessor :end_time     # Integer or nil: nanoseconds from epoch\n  attr_accessor :offset       # String: Valkey stream offset, e.g. "1614890937274-0"\n  attr_reader :topic          # String: Valkey topic, e.g. "DEFAULT__DECOM__{INST}__ADCS"\n  attr_reader :id             # String: unique id, e.g. "ITEM__DECOM__TLM__INST__ADCS__Q1__CONVERTED"\n  attr_reader :realtime       # Boolean: true if end_time is nil or in the future\n  attr_reader :item_key       # String or nil: client-provided key for result mapping\nend\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Format (Items):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"MODE__CMDORTLM__TARGET__PACKET__ITEM__VALUETYPE[__REDUCEDTYPE]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Examples:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"DECOM__TLM__INST__ADCS__Q1__CONVERTED"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"REDUCED_MINUTE__TLM__INST__PARAMS__VALUE1__RAW__AVG"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Format (Packets):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"MODE__CMDORTLM__TARGET__PACKET__VALUETYPE\n"})}),"\n",(0,s.jsx)(n.p,{children:"Examples:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"RAW__TLM__INST__PARAMS"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"DECOM__TLM__INST__PARAMS__CONVERTED"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Topic Format:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SCOPE__TYPE__{TARGET}__PACKET\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Where TYPE is: ",(0,s.jsx)(n.code,{children:"TELEMETRY"}),", ",(0,s.jsx)(n.code,{children:"COMMAND"}),", ",(0,s.jsx)(n.code,{children:"DECOM"}),", ",(0,s.jsx)(n.code,{children:"DECOMCMD"}),", ",(0,s.jsx)(n.code,{children:"REDUCED_MINUTE"}),", ",(0,s.jsx)(n.code,{children:"REDUCED_HOUR"}),", or ",(0,s.jsx)(n.code,{children:"REDUCED_DAY"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"DEFAULT__DECOM__{INST}__ADCS"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"ID Format:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Items: ",(0,s.jsx)(n.code,{children:"ITEM__<key>"})]}),"\n",(0,s.jsxs)(n.li,{children:["Packets: ",(0,s.jsx)(n.code,{children:"PACKET__<key>"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"streamingobjectcollection",children:"StreamingObjectCollection"}),"\n",(0,s.jsx)(n.p,{children:"Thread-safe collection that indexes StreamingObjects for efficient lookup."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ruby",children:"class StreamingObjectCollection\n  @objects                  # Array<StreamingObject> - all objects\n  @objects_by_id            # Hash{String => StreamingObject} - lookup by object.id\n  @topics_and_offsets       # Hash{String => String} - topic => latest offset\n  @item_objects_by_topic    # Hash{String => Array<StreamingObject>} - items grouped by topic\n  @packet_objects_by_topic  # Hash{String => Array<StreamingObject>} - packets grouped by topic\n  @includes_realtime        # Boolean - true if any object has realtime == true\n  @mutex                    # Mutex - protects all internal state\nend\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Offset management:"})," Both ",(0,s.jsx)(n.code,{children:"add()"})," and ",(0,s.jsx)(n.code,{children:"topics_offsets_and_objects()"})," use max-offset-per-topic logic: when multiple objects share a topic, the highest offset is kept. This ensures ",(0,s.jsx)(n.code,{children:"XREAD"})," starts from the most advanced position, avoiding re-reading messages already processed by all objects on that topic. The ",(0,s.jsx)(n.code,{children:"topics_offsets_and_objects()"})," method rebuilds the offset map from scratch on each call to reflect the latest object offsets."]}),"\n",(0,s.jsx)(n.h3,{id:"client-request-format-add",children:"Client Request Format (add)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "scope": "DEFAULT",\n  "token": "<auth_token>",\n  "start_time": 1614890937274290500,\n  "end_time": 1614891537276524900,\n  "items": [\n    ["DECOM__TLM__INST__ADCS__Q1__CONVERTED", "optional_item_key"],\n    ["DECOM__TLM__INST__ADCS__Q2__RAW", null]\n  ],\n  "packets": ["RAW__TLM__INST__PARAMS", "DECOM__TLM__INST__PARAMS__CONVERTED"]\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"start_time"}),": 64-bit nanoseconds from Unix epoch. Omit for realtime-only."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"end_time"}),": 64-bit nanoseconds from Unix epoch. Omit to stream indefinitely."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"items"}),": Array of ",(0,s.jsx)(n.code,{children:"[key, item_key]"})," pairs. ",(0,s.jsx)(n.code,{children:"item_key"})," is used as the key in result JSON (defaults to key string if null)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packets"}),": Array of key strings for whole-packet streaming."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"result-transmission-format",children:"Result Transmission Format"}),"\n",(0,s.jsx)(n.p,{children:"Results are broadcast as JSON arrays via ActionCable. Each entry is one of:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Item Result:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "__type": "ITEMS",\n  "__time": 1614890937274290500,\n  "COSMOS_EXTRA": "{...}",\n  "item_key_1": 42.5,\n  "item_key_2": "ENABLED"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Packet Result (decom/raw):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "__type": "PACKET",\n  "__packet": "RAW__TLM__INST__PARAMS",\n  "__time": 1614890937274290500,\n  "buffer": "<base64_encoded>"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Stream Complete Marker:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:"[]\n"})}),"\n",(0,s.jsx)(n.p,{children:"An empty array signals that all streaming threads have completed."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"thread-model",children:"Thread Model"}),"\n",(0,s.jsx)(n.h3,{id:"thread-hierarchy",children:"Thread Hierarchy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ActionCable WebSocket Connection (managed by AnyCable/Rails)\n  \u2514\u2500\u2500 StreamingApi instance (1 per WebSocket subscription)\n        \u251C\u2500\u2500 RealtimeStreamingThread (0 or 1, singleton per StreamingApi)\n        \u2502     \u2514\u2500\u2500 Ruby Thread: runs redis_thread_body() in a loop\n        \u2514\u2500\u2500 LoggedStreamingThread[] (0..N, one per add() call with start_time)\n              \u2514\u2500\u2500 Ruby Thread: runs thread_body() in a loop\n                    (cycles through SETUP \u2192 TSDB \u2192 STREAM modes)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"thread-1-realtimestreamingthread",children:"Thread 1: RealtimeStreamingThread"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"realtime_streaming_thread.rb"})," (extends ",(0,s.jsx)(n.code,{children:"streaming_thread.rb"}),")"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Lifecycle:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Created when ",(0,s.jsx)(n.code,{children:"add()"})," is called with no ",(0,s.jsx)(n.code,{children:"start_time"}),", or when ",(0,s.jsx)(n.code,{children:"end_time"})," is in the future."]}),"\n",(0,s.jsxs)(n.li,{children:["At most one instance exists per ",(0,s.jsx)(n.code,{children:"StreamingApi"}),". New add requests merge into the existing thread's collection."]}),"\n",(0,s.jsxs)(n.li,{children:["Runs ",(0,s.jsx)(n.code,{children:"redis_thread_body()"})," in an infinite loop."]}),"\n",(0,s.jsxs)(n.li,{children:["Stops when all objects are removed or ",(0,s.jsx)(n.code,{children:"kill()"})," is called."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"OpenC3::Topic.read_topics()"})," (Valkey XREAD) with a 500ms timeout."]}),"\n",(0,s.jsxs)(n.li,{children:["Skips stored packets (",(0,s.jsx)(n.code,{children:'msg_hash["stored"] == true'}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Processes items and packets from each message."}),"\n",(0,s.jsxs)(n.li,{children:["Batches results up to ",(0,s.jsx)(n.code,{children:"@max_batch_size"})," (default 100) before transmitting."]}),"\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"check_for_completed_objects()"})," when no data is received (to detect wall-clock end-time expiry)."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"thread-2-loggedstreamingthread",children:"Thread 2: LoggedStreamingThread"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"logged_streaming_thread.rb"})," (extends ",(0,s.jsx)(n.code,{children:"streaming_thread.rb"}),")"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Lifecycle:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Created when ",(0,s.jsx)(n.code,{children:"add()"})," is called with a ",(0,s.jsx)(n.code,{children:"start_time"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Multiple instances can exist simultaneously (one per ",(0,s.jsx)(n.code,{children:"add()"})," call with ",(0,s.jsx)(n.code,{children:"start_time"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Progresses through three modes: ",(0,s.jsx)(n.code,{children:"SETUP"})," \u2192 ",(0,s.jsx)(n.code,{children:"TSDB"})," or ",(0,s.jsx)(n.code,{children:"STREAM"})," \u2192 ",(0,s.jsx)(n.code,{children:"STREAM"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["After catching up, hands off objects to the ",(0,s.jsx)(n.code,{children:"RealtimeStreamingThread"})," (if the objects have no ",(0,s.jsx)(n.code,{children:"end_time"})," or ",(0,s.jsx)(n.code,{children:"end_time"})," is in the future)."]}),"\n",(0,s.jsx)(n.li,{children:"Stops when all objects expire or handoff completes."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Mode: SETUP"})," (",(0,s.jsx)(n.code,{children:"setup_thread_body"}),")"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Validates that ",(0,s.jsx)(n.code,{children:"start_time"})," is not more than 1 minute in the future."]}),"\n",(0,s.jsx)(n.li,{children:"Queries Valkey for the oldest message on the first object's topic."}),"\n",(0,s.jsxs)(n.li,{children:["Decision logic:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If ",(0,s.jsx)(n.code,{children:"start_time < oldest_time_in_valkey"})," \u2192 switch to ",(0,s.jsx)(n.strong,{children:"TSDB"})," mode (data is too old for Valkey)."]}),"\n",(0,s.jsxs)(n.li,{children:["If ",(0,s.jsx)(n.code,{children:"start_time >= oldest_time_in_valkey"})," \u2192 switch to ",(0,s.jsx)(n.strong,{children:"STREAM"})," mode (data is in Valkey). Calculates a Valkey stream offset by interpolating between Redis time and packet time."]}),"\n",(0,s.jsxs)(n.li,{children:["If no data in Valkey \u2192 switch to ",(0,s.jsx)(n.strong,{children:"TSDB"})," mode."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Mode: TSDB"})," (",(0,s.jsx)(n.code,{children:"tsdb_thread_body"}),")"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Separates objects into regular items, reduced items, and packets."}),"\n",(0,s.jsxs)(n.li,{children:["Regular items: Queries QuestDB with ",(0,s.jsx)(n.code,{children:"SELECT"})," + ",(0,s.jsx)(n.code,{children:"ASOF JOIN"})," across tables, type-aware decoding via ",(0,s.jsx)(n.code,{children:"QuestDBClient.decode_value()"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Reduced items: Queries QuestDB with ",(0,s.jsx)(n.code,{children:"SAMPLE BY"})," aggregation (min, max, avg, stddev) at minute/hour/day intervals."]}),"\n",(0,s.jsxs)(n.li,{children:["Packets:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["RAW packets \u2192 reads from S3 log files via ",(0,s.jsx)(n.code,{children:"StreamingObjectFileReader"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["DECOM packets \u2192 queries QuestDB with ",(0,s.jsx)(n.code,{children:"SELECT *"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["REDUCED packets \u2192 queries QuestDB with ",(0,s.jsx)(n.code,{children:"SAMPLE BY"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Uses paginated queries (",(0,s.jsx)(n.code,{children:"LIMIT min, max"}),") with batch size of 600."]}),"\n",(0,s.jsxs)(n.li,{children:["Retries on ",(0,s.jsx)(n.code,{children:"IOError"})," or ",(0,s.jsx)(n.code,{children:"PG::Error"})," up to 5 times with connection reset."]}),"\n",(0,s.jsxs)(n.li,{children:["Tracks the latest packet timestamp per topic in ",(0,s.jsx)(n.code,{children:"@last_tsdb_times"})," (Hash",e=>nanoseconds,")."]}),"\n",(0,s.jsxs)(n.li,{children:["After completion, calls ",(0,s.jsx)(n.code,{children:"bridge_tsdb_to_stream()"})," to calculate Valkey stream offsets, then switches to ",(0,s.jsx)(n.strong,{children:"STREAM"})," mode."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"TSDB\u2192STREAM Bridge"})," (",(0,s.jsx)(n.code,{children:"bridge_tsdb_to_stream"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"The offset interpolation between TSDB packet timestamps and Valkey stream IDs is approximate (Valkey IDs are wall-clock insertion times, while packet times are generation times). To prevent gaps:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["For each topic with recorded TSDB data, queries ",(0,s.jsx)(n.code,{children:"OpenC3::Topic.get_oldest_message(topic)"})," to get the reference mapping between Valkey stream ID and packet timestamp."]}),"\n",(0,s.jsxs)(n.li,{children:["Applies the same linear interpolation formula as ",(0,s.jsx)(n.code,{children:"setup_thread_body"}),": ",(0,s.jsx)(n.code,{children:"offset = ((last_tsdb_time - TSDB_STREAM_OVERLAP_NSEC + delta) / 1_000_000).to_s + '-0'"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Subtracts a 2-second overlap buffer (",(0,s.jsx)(n.code,{children:"TSDB_STREAM_OVERLAP_NSEC"}),") to ensure the Valkey read starts before where TSDB left off. The overlap filtering in ",(0,s.jsx)(n.code,{children:"redis_thread_body"})," deduplicates."]}),"\n",(0,s.jsx)(n.li,{children:"Sets each object's offset to the calculated value for its topic. Topics without TSDB data retain their existing offsets."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Mode: STREAM"})," (",(0,s.jsx)(n.code,{children:"redis_thread_body"})," overridden from ",(0,s.jsx)(n.code,{children:"StreamingThread"}),")"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["On the first iteration after TSDB\u2192STREAM transition, filters overlap per topic: messages with ",(0,s.jsx)(n.code,{children:"time <= @last_tsdb_times[topic]"})," are skipped (offsets still advance). Once a message passes the filter for a topic, that topic's filter is cleared."]}),"\n",(0,s.jsxs)(n.li,{children:["After all per-topic filters are cleared, delegates to the parent ",(0,s.jsx)(n.code,{children:"redis_thread_body"})," (same as RealtimeStreamingThread)."]}),"\n",(0,s.jsxs)(n.li,{children:["After each iteration, calls ",(0,s.jsx)(n.code,{children:"attempt_handoff_to_realtime()"})," to transfer objects."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"thread-3-bucketfilecache-thread",children:"Thread 3: BucketFileCache Thread"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"openc3/lib/openc3/utilities/bucket_file_cache.rb"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Lifecycle:"})," Singleton background thread, created on first access. Lives for the duration of the process."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Dequeues files from ",(0,s.jsx)(n.code,{children:"@queued_bucket_files"})," and downloads them from S3 to local temp directory."]}),"\n",(0,s.jsxs)(n.li,{children:["Manages disk usage up to ",(0,s.jsx)(n.code,{children:"MAX_DISK_USAGE"})," (default 20GB, configurable via ",(0,s.jsx)(n.code,{children:"OPENC3_BUCKET_FILE_CACHE_SIZE"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Periodically age-checks files (every 3600 seconds) and deletes unreserved files older than 4 hours."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"thread-synchronization",children:"Thread Synchronization"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Mutex"}),(0,s.jsx)(n.th,{children:"Scope"}),(0,s.jsx)(n.th,{children:"Protects"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingApi#@mutex"})}),(0,s.jsx)(n.td,{children:"Per StreamingApi instance"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"@realtime_thread"}),", ",(0,s.jsx)(n.code,{children:"@logged_threads"})," array, handoff operations"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingObjectCollection#@mutex"})}),(0,s.jsx)(n.td,{children:"Per collection"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"@objects"}),", ",(0,s.jsx)(n.code,{children:"@objects_by_id"}),", ",(0,s.jsx)(n.code,{children:"@topics_and_offsets"}),", ",(0,s.jsx)(n.code,{children:"@item_objects_by_topic"}),", ",(0,s.jsx)(n.code,{children:"@packet_objects_by_topic"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoggedStreamingThread.@@conn_mutex"})}),(0,s.jsx)(n.td,{children:"Class-level (shared across all instances)"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"@@conn"})," - shared PG::Connection to QuestDB"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFileCache.@@mutex"})}),(0,s.jsx)(n.td,{children:"Singleton"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"@queued_bucket_files"}),", ",(0,s.jsx)(n.code,{children:"@bucket_file_hash"}),", ",(0,s.jsx)(n.code,{children:"@current_disk_usage"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFile#@mutex"})}),(0,s.jsx)(n.td,{children:"Per file"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"@reservation_count"}),", ",(0,s.jsx)(n.code,{children:"@local_path"}),", file retrieval"]})]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"thread-shutdown-kill",children:["Thread Shutdown (",(0,s.jsx)(n.code,{children:"kill"}),")"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"stop()"})," on the realtime thread and all logged threads (sets ",(0,s.jsx)(n.code,{children:"@cancel_thread = true"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Waits up to ~1.1 seconds for each thread to exit (polling at 10ms intervals)."}),"\n",(0,s.jsxs)(n.li,{children:["Clears references: ",(0,s.jsx)(n.code,{children:"@realtime_thread = nil"}),", ",(0,s.jsx)(n.code,{children:"@logged_threads = []"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Threads self-cleanup via ",(0,s.jsx)(n.code,{children:"ensure"})," block calling ",(0,s.jsx)(n.code,{children:"@streaming_api.complete_thread(self)"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.h3,{id:"realtime-streaming-no-start_time",children:"Realtime Streaming (no start_time)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Client add(data) \u2192\n  StreamingApi#add \u2192\n    Build StreamingObjectCollection \u2192\n    Create/reuse RealtimeStreamingThread \u2192\n      Loop:\n        OpenC3::Topic.read_topics (Valkey XREAD, 500ms timeout) \u2192\n        For each message:\n          Skip if stored == true\n          handle_message() \u2192 handle_json_packet() or handle_raw_packet() \u2192\n          Batch results up to max_batch_size \u2192\n        transmit_results() \u2192\n          ActionCable.server.broadcast(subscription_key, results)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"historical--realtime-streaming-with-start_time-no-end_time",children:"Historical \u2192 Realtime Streaming (with start_time, no end_time)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Client add(data) \u2192\n  StreamingApi#add \u2192\n    Build StreamingObjectCollection \u2192\n    Create LoggedStreamingThread \u2192\n      SETUP: Check Valkey for oldest message \u2192\n        If data too old \u2192 TSDB mode:\n          Query QuestDB (items, packets, reduced) \u2192\n          Track @last_tsdb_times per topic \u2192\n          Transmit batched results \u2192\n          bridge_tsdb_to_stream():\n            For each topic with TSDB data:\n              Look up oldest Valkey message for that topic \u2192\n              Interpolate offset with 2s overlap buffer \u2192\n              Set object offsets for that topic \u2192\n          Switch to STREAM mode\n        If data in Valkey \u2192 STREAM mode:\n          Calculate start offset \u2192\n      STREAM mode:\n        redis_thread_body() reads from Valkey \u2192\n          If @last_tsdb_times has entries for this topic:\n            Skip messages with time <= last_tsdb_time (advance offsets) \u2192\n            Clear filter once past overlap \u2192\n          Process and transmit batched results \u2192\n      attempt_handoff_to_realtime() \u2192\n        StreamingApi#handoff_to_realtime() \u2192\n          Transfer objects to RealtimeStreamingThread \u2192\n          LoggedStreamingThread exits\n"})}),"\n",(0,s.jsx)(n.h3,{id:"historical-only-with-start_time-and-past-end_time",children:"Historical Only (with start_time and past end_time)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Client add(data) \u2192\n  StreamingApi#add \u2192\n    Build StreamingObjectCollection \u2192\n    Create LoggedStreamingThread \u2192\n      SETUP \u2192 TSDB/STREAM \u2192\n        Stream data within time range \u2192\n        objects_active?() detects end_time exceeded \u2192\n        finish() removes completed objects \u2192\n        Thread exits \u2192\n        complete_thread() \u2192\n          transmit_results([], force: true)  (empty array = stream complete)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"latest-item-resolution",children:"LATEST Item Resolution"}),"\n",(0,s.jsxs)(n.p,{children:["When an item key contains ",(0,s.jsx)(n.code,{children:"LATEST"})," as the packet name (e.g., ",(0,s.jsx)(n.code,{children:"DECOM__TLM__INST__LATEST__TEMP1__CONVERTED"}),"), the ",(0,s.jsx)(n.code,{children:"build_item_collection()"})," method resolves it:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"OpenC3::TargetModel.get_item_to_packet_map(target_name)"})," to find all packets containing that item."]}),"\n",(0,s.jsxs)(n.li,{children:["Creates one ",(0,s.jsx)(n.code,{children:"StreamingObject"})," per packet, each sharing the same ",(0,s.jsx)(n.code,{children:"item_key"})," for result mapping."]}),"\n",(0,s.jsx)(n.li,{children:"The client receives whichever packet updates first (all map to the same output key)."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"handoff-logged--realtime",children:"Handoff: Logged \u2192 Realtime"}),"\n",(0,s.jsxs)(n.p,{children:["The handoff mechanism in ",(0,s.jsx)(n.code,{children:"StreamingThread#handoff()"})," compares offsets between the logged thread's collection and the realtime thread's collection:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["For each topic in the logged collection (indexed by ",(0,s.jsx)(n.code,{children:"index"}),"):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Looks up the topic's position in the realtime collection (",(0,s.jsx)(n.code,{children:"my_index = my_topics.index(topic)"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["If the realtime thread has the same topic and the logged offset (",(0,s.jsx)(n.code,{children:"offsets[index]"}),") >= realtime offset (",(0,s.jsx)(n.code,{children:"my_offsets[my_index]"}),") \u2192 ",(0,s.jsx)(n.strong,{children:"caught up"}),", transfer objects."]}),"\n",(0,s.jsxs)(n.li,{children:["If the realtime thread doesn't have this topic \u2192 ",(0,s.jsx)(n.strong,{children:"new topic"}),", transfer objects."]}),"\n",(0,s.jsxs)(n.li,{children:["If the logged offset < realtime offset \u2192 ",(0,s.jsx)(n.strong,{children:"not caught up"}),", keep in logged thread."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Objects are moved from the logged collection to the realtime collection."}),"\n",(0,s.jsx)(n.li,{children:"If all objects are transferred, the logged thread cancels itself."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," The offset comparison uses ",(0,s.jsx)(n.code,{children:"my_index"})," (the topic's position in the realtime collection) to look up ",(0,s.jsx)(n.code,{children:"my_offsets"}),", not ",(0,s.jsx)(n.code,{children:"index"})," (the logged collection's position). These differ when the two collections have topics in different orders."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-sources",children:"Data Sources"}),"\n",(0,s.jsx)(n.h3,{id:"1-valkey-redis-streams",children:"1. Valkey (Redis) Streams"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Used by:"})," ",(0,s.jsx)(n.code,{children:"RealtimeStreamingThread"}),", ",(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})," (STREAM mode)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Access:"})," ",(0,s.jsx)(n.code,{children:"OpenC3::Topic.read_topics()"})," (wraps ",(0,s.jsx)(n.code,{children:"EphemeralStore.read_topics"})," / Valkey XREAD)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Topics:"})," ",(0,s.jsx)(n.code,{children:"SCOPE__TYPE__{TARGET}__PACKET"})," (e.g., ",(0,s.jsx)(n.code,{children:"DEFAULT__DECOM__{INST}__ADCS"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Message Fields:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"time"})," - packet timestamp (nanoseconds)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"stored"})," - boolean, true for non-realtime packets"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buffer"})," - raw binary data (RAW mode)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"json_data"})," - JSON string of decommutated values (DECOM mode)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"extra"})," - optional JSON metadata (COSMOS_EXTRA)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-questdb-time-series-database",children:"2. QuestDB (Time-Series Database)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Used by:"})," ",(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})," (TSDB mode)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Access:"})," ",(0,s.jsx)(n.code,{children:"PG::Connection"})," via PostgreSQL wire protocol"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Connection:"})," Shared class-level ",(0,s.jsx)(n.code,{children:"@@conn"})," protected by ",(0,s.jsx)(n.code,{children:"@@conn_mutex"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Environment Variables:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OPENC3_TSDB_HOSTNAME"})," - QuestDB host"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OPENC3_TSDB_QUERY_PORT"})," - PostgreSQL query port"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"OPENC3_TSDB_USERNAME"})," / ",(0,s.jsx)(n.code,{children:"OPENC3_TSDB_PASSWORD"})," - credentials"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Table Names:"})," ",(0,s.jsx)(n.code,{children:"CMDORTLM__TARGET__PACKET"})," (sanitized), e.g., ",(0,s.jsx)(n.code,{children:"TLM__INST__PARAMS"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Query Patterns:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Items: ",(0,s.jsx)(n.code,{children:"SELECT col1, col2, ... FROM T0 [ASOF JOIN T1 ...] WHERE T0.PACKET_TIMESECONDS >= X LIMIT min, max"})]}),"\n",(0,s.jsxs)(n.li,{children:["Packets: ",(0,s.jsx)(n.code,{children:"SELECT * FROM table WHERE PACKET_TIMESECONDS >= X LIMIT min, max"})]}),"\n",(0,s.jsxs)(n.li,{children:["Reduced: ",(0,s.jsx)(n.code,{children:"SELECT min(col), max(col), avg(col), stddev(col) FROM table WHERE ... SAMPLE BY 1m|1h|1d ALIGN TO CALENDAR ORDER BY PACKET_TIMESECONDS LIMIT min, max"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Type Mapping:"})," Uses ",(0,s.jsx)(n.code,{children:"PG::BasicTypeMapForResults"})," for automatic type conversion, plus ",(0,s.jsx)(n.code,{children:"QuestDBClient.decode_value()"})," for COSMOS-specific types (arrays, blocks, 64-bit integers, sentinel float values)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Retry Logic:"})," Up to 5 retries on ",(0,s.jsx)(n.code,{children:"IOError"})," or ",(0,s.jsx)(n.code,{children:"PG::Error"}),", with connection reset between retries."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-s3-bucket-log-files",children:"3. S3 Bucket Log Files"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Used by:"})," ",(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})," \u2192 ",(0,s.jsx)(n.code,{children:"StreamingObjectFileReader"})," (RAW packet mode only)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Access:"})," ",(0,s.jsx)(n.code,{children:"BucketFileCache"})," (singleton) \u2192 ",(0,s.jsx)(n.code,{children:"OpenC3::Bucket"})," (S3 client)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File Format:"})," Compressed binary log files (",(0,s.jsx)(n.code,{children:".bin.gz"}),") in bucket paths like:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SCOPE/stream_mode_logs/cmd_or_tlm/TARGET/YYYYMMDD/TIMESTAMP__TIMESTAMP__SCOPE__TARGET__PACKET__rt__mode.bin.gz\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Reading:"})," ",(0,s.jsx)(n.code,{children:"BufferedPacketLogReader"})," with a buffer depth of 10 packets for time-ordered merging across multiple files."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File Discovery:"})," ",(0,s.jsx)(n.code,{children:"OpenC3::BucketUtilities.files_between_time()"})," lists files whose time ranges overlap the requested period."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Environment Variable"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_LOGS_BUCKET"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"S3 bucket name for log files"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_TSDB_HOSTNAME"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"QuestDB hostname"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_TSDB_QUERY_PORT"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"QuestDB PostgreSQL wire protocol port"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_TSDB_USERNAME"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"QuestDB username"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_TSDB_PASSWORD"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"QuestDB password"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OPENC3_BUCKET_FILE_CACHE_SIZE"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"20000000000"})," (20GB)"]}),(0,s.jsx)(n.td,{children:"Max local disk usage for cached bucket files"})]})]})]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Constant"}),(0,s.jsx)(n.th,{children:"Value"}),(0,s.jsx)(n.th,{children:"Location"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ALLOWABLE_START_TIME_OFFSET_NSEC"})}),(0,s.jsx)(n.td,{children:"60 seconds (in ns)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})}),(0,s.jsx)(n.td,{children:"Max allowed start_time in the future"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"TSDB_STREAM_OVERLAP_NSEC"})}),(0,s.jsx)(n.td,{children:"2 seconds (in ns)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})}),(0,s.jsx)(n.td,{children:"Overlap buffer when bridging from TSDB to Valkey stream. Ensures no gaps from offset interpolation imprecision."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"max_batch_size"})," (realtime)"]}),(0,s.jsx)(n.td,{children:"100"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StreamingThread"})}),(0,s.jsx)(n.td,{children:"Max results per ActionCable broadcast (realtime)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"max_batch_size"})," (logged)"]}),(0,s.jsx)(n.td,{children:"600"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})}),(0,s.jsx)(n.td,{children:"Max results per ActionCable broadcast (historical)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFile::MAX_AGE_SECONDS"})}),(0,s.jsx)(n.td,{children:"14400 (4 hours)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFileCache"})}),(0,s.jsx)(n.td,{children:"Max age for unreserved cached files"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFileCache::CHECK_TIME_SECONDS"})}),(0,s.jsx)(n.td,{children:"3600 (1 hour)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BucketFileCache"})}),(0,s.jsx)(n.td,{children:"Interval for age-checking cached files"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BufferedPacketLogReader buffer_depth"})}),(0,s.jsx)(n.td,{children:"10"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BufferedPacketLogReader"})}),(0,s.jsx)(n.td,{children:"Number of packets buffered for time-ordered reading"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authorization errors"})," (",(0,s.jsx)(n.code,{children:"OpenC3::AuthError"}),", ",(0,s.jsx)(n.code,{children:"OpenC3::ForbiddenError"}),"): Caught in ",(0,s.jsx)(n.code,{children:"StreamingChannel"}),", transmit ",(0,s.jsx)(n.code,{children:'{"error": "unauthorized"}'})," and reject the subscription."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:["General errors in ",(0,s.jsx)(n.code,{children:"StreamingChannel"})]}),": Transmit ",(0,s.jsx)(n.code,{children:'{"error": "ClassName:message"}'})," and reject the subscription."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Thread crashes"}),": Caught by ",(0,s.jsx)(n.code,{children:"rescue => e"})," in ",(0,s.jsx)(n.code,{children:"StreamingThread#start"}),". Logs error and calls ",(0,s.jsx)(n.code,{children:"complete_thread(self)"})," via ",(0,s.jsx)(n.code,{children:"ensure"})," block."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"QuestDB connection errors"})," (",(0,s.jsx)(n.code,{children:"IOError"}),", ",(0,s.jsx)(n.code,{children:"PG::Error"}),"): Retry up to 5 times with connection reset. Raise after 5th retry."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"S3 retrieval errors"}),": ",(0,s.jsx)(n.code,{children:"BucketFile#retrieve"})," retries up to 3 times with 1-second sleep between attempts."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Start time too far in future"}),": ",(0,s.jsx)(n.code,{children:"LoggedStreamingThread"})," finishes objects and cancels if ",(0,s.jsx)(n.code,{children:"start_time"})," exceeds current time by more than 60 seconds."]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},9496:function(e,n,t){t.d(n,{R:()=>d,x:()=>c});var i=t(9471);let s={},r=i.createContext(s);function d(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);