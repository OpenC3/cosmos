"use strict";(self.webpackChunkdocs_openc3_com=self.webpackChunkdocs_openc3_com||[]).push([["9967"],{8647:function(e,n,s){s.r(n),s.d(n,{metadata:()=>r,default:()=>h,frontMatter:()=>t,contentTitle:()=>l,toc:()=>d,assets:()=>o});var r=JSON.parse('{"id":"development/microservices","title":"Microservices","description":"Building custom microservices for COSMOS","source":"@site/docs/development/microservices.md","sourceDirName":"development","slug":"/development/microservices","permalink":"/docs/development/microservices","draft":false,"unlisted":false,"editUrl":"https://github.com/OpenC3/cosmos/tree/main/docs.openc3.com/docs/development/microservices.md","tags":[],"version":"current","frontMatter":{"title":"Microservices","description":"Building custom microservices for COSMOS","sidebar_custom_props":{"myEmoji":"\u{1F527}"}},"sidebar":"defaultSidebar","previous":{"title":"Log Structure","permalink":"/docs/development/log-structure"},"next":{"title":"Roadmap","permalink":"/docs/development/roadmap"}}'),i=s(5656),c=s(5395);let t={title:"Microservices",description:"Building custom microservices for COSMOS",sidebar_custom_props:{myEmoji:"\u{1F527}"}},l,o={},d=[{value:"Creating a Microservice",id:"creating-a-microservice",level:2},{value:"Microservice Structure",id:"microservice-structure",level:2},{value:"Plugin Configuration",id:"plugin-configuration",level:2},{value:"Available Keywords",id:"available-keywords",level:3},{value:"Available APIs",id:"available-apis",level:2},{value:"Base Class Attributes",id:"base-class-attributes",level:2},{value:"Logging",id:"logging",level:2},{value:"Alert Notifications",id:"alert-notifications",level:3},{value:"State Management",id:"state-management",level:2},{value:"Custom Status",id:"custom-status",level:2},{value:"Secrets",id:"secrets",level:2},{value:"HTTP Endpoints",id:"http-endpoints",level:2},{value:"Metrics",id:"metrics",level:2},{value:"Metric Types",id:"metric-types",level:3},{value:"Subscribing to Topics",id:"subscribing-to-topics",level:2},{value:"Lifecycle Methods",id:"lifecycle-methods",level:2},{value:"Example: Safety Monitor",id:"example-safety-monitor",level:2}];function a(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components},{TabItem:s,Tabs:r}=n;return s||p("TabItem",!0),r||p("Tabs",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Microservices are persistent background processes that run within the COSMOS environment. They can process data, perform periodic tasks, and provide custom functionality to extend COSMOS."}),"\n",(0,i.jsx)(n.h2,{id:"creating-a-microservice",children:"Creating a Microservice"}),"\n",(0,i.jsxs)(n.p,{children:["The easiest way to create a microservice is to use the ",(0,i.jsx)(n.a,{href:"/docs/getting-started/generators#microservice-generator",children:"generator"})," to create the scaffolding for a new COSMOS Microservice. It must operate inside an existing COSMOS plugin. For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"openc3-cosmos-myplugin % openc3.sh cli generate microservice\nUsage: cli generate microservice <NAME> (--ruby or --python)\n\nopenc3-cosmos-myplugin % openc3.sh cli generate microservice background --python\nMicroservice BACKGROUND successfully generated!\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This creates a ",(0,i.jsx)(n.code,{children:"microservices/BACKGROUND/"})," directory containing ",(0,i.jsx)(n.code,{children:"background.py"})," with a fully functional microservice template."]}),"\n",(0,i.jsx)(n.h2,{id:"microservice-structure",children:"Microservice Structure"}),"\n",(0,i.jsxs)(n.p,{children:["A microservice must extend the ",(0,i.jsx)(n.code,{children:"Microservice"})," base class and implement a ",(0,i.jsx)(n.code,{children:"run"})," method. Here's the basic structure:"]}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"import time\nfrom openc3.microservices.microservice import Microservice\nfrom openc3.utilities.sleeper import Sleeper\nfrom openc3.api import *\n\nclass BackgroundMicroservice(Microservice):\n    def __init__(self, name):\n        super().__init__(name)\n        # Parse OPTION keywords from plugin.txt\n        for option in self.config['options']:\n            match option[0].upper():\n                case 'PERIOD':\n                    self.period = int(option[1])\n                case _:\n                    self.logger.error(\n                        f\"Unknown option passed to microservice {name}: {option}\"\n                    )\n        if not hasattr(self, 'period'):\n            self.period = 60  # Default to 60 seconds\n        self.sleeper = Sleeper()\n\n    def run(self):\n        while True:\n            start_time = time.time()\n            if self.cancel_thread:\n                break\n\n            # Do your microservice work here\n            self.logger.info(\"BackgroundMicroservice ran\")\n\n            run_time = time.time() - start_time\n            delta = self.period - run_time\n            if delta > 0:\n                if self.sleeper.sleep(delta):\n                    break\n            self.count += 1\n\n    def shutdown(self):\n        self.sleeper.cancel()\n        super().shutdown()\n\nif __name__ == \"__main__\":\n    BackgroundMicroservice.class_run()\n"})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"require 'openc3/microservices/microservice'\nrequire 'openc3/api/api'\n\nmodule OpenC3\n  class BackgroundMicroservice < Microservice\n    include Api # Provides access to api methods\n\n    def initialize(name)\n      super(name)\n      @config['options'].each do |option|\n        case option[0].upcase\n        when 'PERIOD'\n          @period = option[1].to_i\n        else\n          @logger.error(\"Unknown option passed to microservice #{@name}: #{option}\")\n        end\n      end\n      @period = 60 unless @period # Default to 60 seconds\n      @sleeper = Sleeper.new\n    end\n\n    def run\n      while true\n        start_time = Time.now\n        break if @cancel_thread\n\n        # Do your microservice work here\n        @logger.info(\"BackgroundMicroservice ran\")\n\n        run_time = Time.now - start_time\n        delta = @period - run_time\n        if delta > 0\n          break if @sleeper.sleep(delta)\n        end\n        @count += 1\n      end\n    end\n\n    def shutdown\n      @sleeper.cancel\n      super()\n    end\n  end\nend\n\nOpenC3::BackgroundMicroservice.run if __FILE__ == $0\n"})})})]}),"\n",(0,i.jsx)(n.h2,{id:"plugin-configuration",children:"Plugin Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Microservices are declared in the ",(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#microservice",children:"plugin.txt"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"MICROSERVICE BACKGROUND background-microservice\n  CMD python background.py\n  OPTION PERIOD 30\n"})}),"\n",(0,i.jsx)(n.h3,{id:"available-keywords",children:"Available Keywords"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Keyword"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#cmd-1",children:"CMD"})}),(0,i.jsx)(n.td,{children:"Command to execute the microservice"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#env-1",children:"ENV"})}),(0,i.jsx)(n.td,{children:"Set environment variables"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#work_dir-1",children:"WORK_DIR"})}),(0,i.jsx)(n.td,{children:"Set the working directory"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#port-1",children:"PORT"})}),(0,i.jsx)(n.td,{children:"Expose a port for HTTP access"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#topic",children:"TOPIC"})}),(0,i.jsx)(n.td,{children:"Subscribe to Redis topics"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#target_name",children:"TARGET_NAME"})}),(0,i.jsx)(n.td,{children:"Associate a target with the microservice"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#option-1",children:"OPTION"})}),(0,i.jsx)(n.td,{children:"Pass custom options to the microservice"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#secret-1",children:"SECRET"})}),(0,i.jsx)(n.td,{children:"Mount secrets (environment variables or files)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#route_prefix-1",children:"ROUTE_PREFIX"})}),(0,i.jsx)(n.td,{children:"Expose the microservice via Traefik"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#shard-2",children:"SHARD"})}),(0,i.jsx)(n.td,{children:"Assign to a specific operator shard"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#container-1",children:"CONTAINER"})}),(0,i.jsx)(n.td,{children:"Docker container image (Enterprise)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#stopped",children:"STOPPED"})}),(0,i.jsx)(n.td,{children:"Start in disabled state"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"available-apis",children:"Available APIs"}),"\n",(0,i.jsxs)(n.admonition,{title:"API vs Script",type:"warning",children:[(0,i.jsxs)(n.p,{children:["When writing code for a microservice (or interface) that runs ",(0,i.jsx)(n.em,{children:"within"})," COSMOS, you must use the ",(0,i.jsx)(n.code,{children:"openc3/api"})," library, ",(0,i.jsx)(n.strong,{children:"NOT"})," ",(0,i.jsx)(n.code,{children:"openc3/script"}),"."]}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"openc3/api"})," - For code running inside the COSMOS cluster (microservices, interfaces)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"openc3/script"})," - For external scripts connecting to COSMOS from outside the cluster"]}),"\n"]}),(0,i.jsx)(n.p,{children:"Since microservices run inside the COSMOS cluster, they can make direct connections to the database and do not need external authentication."}),(0,i.jsxs)(n.p,{children:["For more information see ",(0,i.jsx)(n.a,{href:"/docs/guides/script-writing#api-vs-script",children:"API vs Script"}),"."]})]}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from openc3.api import *\n"})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"require 'openc3/api/api'\n# Then include in your class:\ninclude Api\n"})})})]}),"\n",(0,i.jsxs)(n.p,{children:["The API module provides access to the ",(0,i.jsx)(n.a,{href:"/docs/guides/scripting-api",children:"Scripting API"})," methods for commanding and telemetry:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"API Category"}),(0,i.jsx)(n.th,{children:"Key Methods"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Commands"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"cmd"}),", ",(0,i.jsx)(n.code,{children:"cmd_no_hazardous_check"}),", ",(0,i.jsx)(n.code,{children:"cmd_raw"}),", ",(0,i.jsx)(n.code,{children:"build_cmd"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Telemetry"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"tlm"}),", ",(0,i.jsx)(n.code,{children:"tlm_raw"}),", ",(0,i.jsx)(n.code,{children:"tlm_formatted"}),", ",(0,i.jsx)(n.code,{children:"tlm_with_units"}),", ",(0,i.jsx)(n.code,{children:"set_tlm"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Limits"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"get_limits"}),", ",(0,i.jsx)(n.code,{children:"set_limits"}),", ",(0,i.jsx)(n.code,{children:"enable_limits"}),", ",(0,i.jsx)(n.code,{children:"disable_limits"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Targets"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"get_target_names"}),", ",(0,i.jsx)(n.code,{children:"get_all_cmds"}),", ",(0,i.jsx)(n.code,{children:"get_all_tlm"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Interfaces"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"get_interface"}),", ",(0,i.jsx)(n.code,{children:"connect_interface"}),", ",(0,i.jsx)(n.code,{children:"disconnect_interface"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Settings"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"get_setting"}),", ",(0,i.jsx)(n.code,{children:"set_setting"}),", ",(0,i.jsx)(n.code,{children:"get_all_settings"})]})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"base-class-attributes",children:"Base Class Attributes"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Microservice"})," base class provides these attributes:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Attribute"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"name"})}),(0,i.jsxs)(n.td,{children:["Full microservice name (format: ",(0,i.jsx)(n.code,{children:"SCOPE__TYPE__NAME"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"scope"})}),(0,i.jsx)(n.td,{children:"Scope extracted from the name"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"state"})}),(0,i.jsxs)(n.td,{children:["Current state: ",(0,i.jsx)(n.code,{children:"INITIALIZED"}),", ",(0,i.jsx)(n.code,{children:"RUNNING"}),", ",(0,i.jsx)(n.code,{children:"FINISHED"}),", ",(0,i.jsx)(n.code,{children:"DIED_ERROR"}),", ",(0,i.jsx)(n.code,{children:"STOPPED"}),", ",(0,i.jsx)(n.code,{children:"KILLED"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"count"})}),(0,i.jsx)(n.td,{children:"Operation counter (increment in your run loop)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"error"})}),(0,i.jsx)(n.td,{children:"Last error encountered"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"custom"})}),(0,i.jsx)(n.td,{children:"Custom status data (displayed in Admin Microservices tab)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"logger"})}),(0,i.jsx)(n.td,{children:"Logger instance for output"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"config"})}),(0,i.jsx)(n.td,{children:"Configuration from plugin.txt (topics, target_names, options, secrets)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"secrets"})}),(0,i.jsx)(n.td,{children:"Secrets client for accessing sensitive data"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cancel_thread"})}),(0,i.jsx)(n.td,{children:"Boolean flag to check for shutdown requests"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"topics"})}),(0,i.jsx)(n.td,{children:"List of Redis topics to monitor"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"target_names"})}),(0,i.jsx)(n.td,{children:"Associated target names"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,i.jsx)(n.p,{children:"Use the built-in logger for output. Log messages appear in container logs and the Admin Log Messages panel:"}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'self.logger.debug("Debug message")\nself.logger.info("Info message")\nself.logger.warn("Warning message")\nself.logger.error("Error message")\nself.logger.fatal("Fatal message")\n'})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:'@logger.debug("Debug message")\n@logger.info("Info message")\n@logger.warn("Warning message")\n@logger.error("Error message")\n@logger.fatal("Fatal message")\n'})})})]}),"\n",(0,i.jsx)(n.h3,{id:"alert-notifications",children:"Alert Notifications"}),"\n",(0,i.jsxs)(n.p,{children:["To display a log message as a notification in the COSMOS UI, pass the ",(0,i.jsx)(n.code,{children:"type"})," parameter:"]}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from openc3.utilities.logger import Logger\n\n# Show as a notification toast in the UI\nself.logger.error("Critical issue detected", type=Logger.ALERT)\n'})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:'# Show as a notification toast in the UI\n@logger.error("Critical issue detected", type: Logger::ALERT)\n'})})})]}),"\n",(0,i.jsx)(n.p,{children:"The available types are:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"LOG"})," (default) - Standard log message, appears in Log Messages panel"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"NOTIFICATION"})," - Appears in the notifications dropdown"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ALERT"})," - Appears as a toast notification and in the notifications dropdown"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"state-management",children:"State Management"}),"\n",(0,i.jsxs)(n.p,{children:["Update ",(0,i.jsx)(n.code,{children:"state"})," to communicate status to users viewing the Admin Microservices tab."]}),"\n",(0,i.jsx)(n.admonition,{title:"Polling Interval",type:"note",children:(0,i.jsx)(n.p,{children:"The microservice status is polled by the frontend every few seconds. Only long-running states will be visible to users. Rapid state changes may not be displayed."})}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"self.state = 'CALCULATING'\n# ... perform calculation\nself.state = 'RUNNING'\n"})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"@state = 'CALCULATING'\n# ... perform calculation\n@state = 'RUNNING'\n"})})})]}),"\n",(0,i.jsx)(n.h2,{id:"custom-status",children:"Custom Status"}),"\n",(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(n.code,{children:"custom"})," to display additional information in the Admin Microservices tab. Like state, custom status is polled by the frontend so only persistent values will be visible."]}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'self.custom = {"processed": 100, "errors": 2}\n'})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:'@custom = {"processed" => 100, "errors" => 2}\n'})})})]}),"\n",(0,i.jsx)(n.h2,{id:"secrets",children:"Secrets"}),"\n",(0,i.jsxs)(n.p,{children:["Access secrets defined in plugin.txt with the ",(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#secret-1",children:"SECRET"})," keyword:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"SECRET ENV MY_API_KEY API_KEY_ENV\nSECRET FILE MY_CERT /path/to/cert.pem\n"})}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Environment secrets are automatically available\nimport os\napi_key = os.environ.get('API_KEY_ENV')\n\n# Or use the secrets client\nvalue = self.secrets.get('MY_API_KEY', scope=self.scope)\n"})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"# Environment secrets are automatically available\napi_key = ENV['API_KEY_ENV']\n\n# Or use the secrets client\nvalue = @secrets.get('MY_API_KEY', scope: @scope)\n"})})})]}),"\n",(0,i.jsx)(n.h2,{id:"http-endpoints",children:"HTTP Endpoints"}),"\n",(0,i.jsxs)(n.p,{children:["To expose your microservice via HTTP, use the ",(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#port-1",children:"PORT"})," and ",(0,i.jsx)(n.a,{href:"/docs/configuration/plugins#route_prefix-1",children:"ROUTE_PREFIX"})," keywords. See ",(0,i.jsx)(n.a,{href:"/docs/guides/exposing-microservices",children:"Exposing Microservices"})," for details."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"MICROSERVICE MYAPI my-api-service\n  CMD python api_server.py\n  PORT 8080\n  ROUTE_PREFIX /myapi\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This makes the microservice accessible at ",(0,i.jsx)(n.code,{children:"http://localhost:2900/myapi"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"metrics",children:"Metrics"}),"\n",(0,i.jsx)(n.p,{children:"Track performance metrics using the built-in metric system:"}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"self.metric.set(name='requests_total', value=self.count, type='counter')\nself.metric.set(name='processing_seconds', value=elapsed, type='gauge', unit='seconds')\n"})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"@metric.set(name: 'requests_total', value: @count, type: 'counter')\n@metric.set(name: 'processing_seconds', value: elapsed, type: 'gauge', unit: 'seconds')\n"})})})]}),"\n",(0,i.jsx)(n.h3,{id:"metric-types",children:"Metric Types"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"counter"})}),(0,i.jsx)(n.td,{children:"A cumulative value that only increases (e.g., total requests, total errors). Resets to zero when the service restarts."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"gauge"})}),(0,i.jsx)(n.td,{children:"A point-in-time value that can increase or decrease (e.g., current temperature, queue depth, memory usage)."})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"subscribing-to-topics",children:"Subscribing to Topics"}),"\n",(0,i.jsxs)(n.p,{children:["Microservices can subscribe to Redis topics to receive telemetry or command streams. Use the ",(0,i.jsx)(n.code,{children:"TOPIC"})," keyword in plugin.txt:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"MICROSERVICE MONITOR telemetry-monitor\n  CMD python monitor.py\n  TOPIC DEFAULT__DECOM__{INST}__HEALTH_STATUS\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then process messages in your run loop:"}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from openc3.topics.topic import Topic\n\ndef run(self):\n    while True:\n        if self.cancel_thread:\n            break\n        for topic, msg_id, msg_hash, redis in Topic.read_topics(self.topics):\n            # Process the message\n            self.logger.info(f"Received message on {topic}")\n            self.count += 1\n'})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:'def run\n  while true\n    break if @cancel_thread\n    Topic.read_topics(@topics) do |topic, msg_id, msg_hash, redis|\n      # Process the message\n      @logger.info("Received message on #{topic}")\n      @count += 1\n    end\n  end\nend\n'})})})]}),"\n",(0,i.jsx)(n.h2,{id:"lifecycle-methods",children:"Lifecycle Methods"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"__init__"})," / ",(0,i.jsx)(n.code,{children:"initialize"})]}),(0,i.jsx)(n.td,{children:"Constructor - parse options, initialize state"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"run"})}),(0,i.jsxs)(n.td,{children:["Main execution loop - ",(0,i.jsx)(n.strong,{children:"must be implemented"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"shutdown"})}),(0,i.jsxs)(n.td,{children:["Cleanup when stopping - call ",(0,i.jsx)(n.code,{children:"super()"})," at the end"]})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"example-safety-monitor",children:"Example: Safety Monitor"}),"\n",(0,i.jsx)(n.p,{children:"This example monitors telemetry and takes action when values exceed thresholds:"}),"\n",(0,i.jsxs)(r,{groupId:"script-language",children:[(0,i.jsx)(s,{value:"python",label:"Python",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import time\nfrom openc3.microservices.microservice import Microservice\nfrom openc3.utilities.sleeper import Sleeper\nfrom openc3.api import *\n\nclass SafetyMonitor(Microservice):\n    def __init__(self, name):\n        super().__init__(name)\n        self.threshold = 100.0\n        for option in self.config[\'options\']:\n            if option[0].upper() == \'THRESHOLD\':\n                self.threshold = float(option[1])\n        self.sleeper = Sleeper()\n\n    def run(self):\n        while True:\n            if self.cancel_thread:\n                break\n\n            # Check telemetry value\n            temp = tlm("INST", "HEALTH_STATUS", "TEMP1")\n\n            if temp > self.threshold:\n                self.logger.warn(f"Temperature {temp} exceeds threshold {self.threshold}")\n                self.state = \'WARNING\'\n                # Take corrective action\n                cmd("INST", "SAFE_MODE")\n            else:\n                self.state = \'RUNNING\'\n\n            self.count += 1\n            if self.sleeper.sleep(1):\n                break\n\n    def shutdown(self):\n        self.sleeper.cancel()\n        super().shutdown()\n\nif __name__ == "__main__":\n    SafetyMonitor.class_run()\n'})})}),(0,i.jsx)(s,{value:"ruby",label:"Ruby",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"require 'openc3/microservices/microservice'\nrequire 'openc3/api/api'\n\nmodule OpenC3\n  class SafetyMonitor < Microservice\n    include Api\n\n    def initialize(name)\n      super(name)\n      @threshold = 100.0\n      @config['options'].each do |option|\n        if option[0].upcase == 'THRESHOLD'\n          @threshold = option[1].to_f\n        end\n      end\n      @sleeper = Sleeper.new\n    end\n\n    def run\n      while true\n        break if @cancel_thread\n\n        # Check telemetry value\n        temp = tlm(\"INST\", \"HEALTH_STATUS\", \"TEMP1\")\n\n        if temp > @threshold\n          @logger.warn(\"Temperature #{temp} exceeds threshold #{@threshold}\")\n          @state = 'WARNING'\n          # Take corrective action\n          cmd(\"INST\", \"SAFE_MODE\")\n        else\n          @state = 'RUNNING'\n        end\n\n        @count += 1\n        break if @sleeper.sleep(1)\n      end\n    end\n\n    def shutdown\n      @sleeper.cancel\n      super()\n    end\n  end\nend\n\nOpenC3::SafetyMonitor.run if __FILE__ == $0\n"})})})]}),"\n",(0,i.jsx)(n.p,{children:"Configure in plugin.txt:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ruby",children:"MICROSERVICE SAFETY safety-monitor\n  CMD python safety_monitor.py\n  OPTION THRESHOLD 90.0\n"})})]})}function h(e={}){let{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}function p(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},5395:function(e,n,s){s.d(n,{R:()=>t,x:()=>l});var r=s(7140);let i={},c=r.createContext(i);function t(e){let n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);